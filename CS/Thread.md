# Thread


- 어플리케이션의 코드를 한 줄씩 순차적으로 실행
- 자바의 경우, 메인 메서드르 처음 실행하면 main이라는 이름의 스레드가 실행 됨
- 스레드가 없으면 어플리케이션 실행 불가
- 스레드는 한번에 한 줄의 코드만 실행 하기 때문에, 동시처리가 필요한 경우 다른 스레드를 추가로 생성해야함


## Thread Pool

- [?](Web/서블릿.md)을 호출하기 위해 스레드를 사용할 때, 매 요청마다 새로운 스레드를 생성하는 방식이라면?
	- [p] 장점 :
		- 동시 요청을 처리할 수 있다.
		- 리소스(CPU, 메모리)가 허용할 때 까지 처리가능
		- 하나의 스레드가 지연되어도, 나머지 스레드는 정상 동작
	- [c] 단점 :
		- 스레드의 비싼 생성 비용 때문에, 매 요청 마다 생성시에는 속도 저하 발생
		- 스레드의 경우 [Context Switching](../미완성%20문서/Context%20Switching.md) 비용이 발생
		- 스레드 생성에 제한이 없기 때문에, 대량의 고객 요청에 맞춰 대량의 스레드를 생성하다 CPU 및 메모리 임계점을 넘으면 서버가 다운될 수 있다.

- [I] 위의 스레드 생성 방식의 단점을 보완하기 위한 것이 **Thread Pool** 방식
	- 필요한 스레드를 미리 만들어서 스레드 풀에 보관하고 관리
	- 스레드 풀에 생성 가능한 스레드의 최대치를 관리
		- [Tomcat](../미완성%20문서/Tomcat.md)의 경우 최대값의 default 는 200개
	- 스레드가 필요한 경우, 이미 생성되어 있는 스레드를 풀에서 꺼내서 사용
	- 사용 후에는 다시 스레드 풀에 반납
	- 최대 스레드가 모두 사용 중인 경우
		- 기다리는 요청 거절
		- 혹은 특정 숫자만큼 대기하도록 설정
	- [p] 장점 :
		- 스레드가 미리 생성되어 있음 -> 스레드를 생성하고 삭제하는 비용을 절약하여 응답 속도가 빠르다
		- 생성 가능한 스레드치가 정해져 있으므로, 많은 요청이 들어와도 이미 처리중인 요청은 안전하게 처리


## [WAS](Web/Web%20Application%20Server.md)와 멀티 스레드

- WAS가 멀티스레드에 대한 부분을 알아서 처리
- 개발자는 싱글 스레드 프로그래밍 처럼 편리하게 개발
	- 단, [싱글톤](디자인%20패턴/싱글톤%20패턴.md) 객체( [서블릿](Web/서블릿.md), [스프링 빈](../Spring/스프링%20빈.md) 등) 의 경우에는, 멀티 스레드 환경에서 다루고 있음을 유의해서 사용

- [f] WAS의 경우 주요 튜닝 포인트는 최대 스레드의 수
	- 너무 낮게 잡는 경우, 동시에 처리할 수 있는 요청의 수가 줄어 클라이언트 응답 지연이 늘어날 수 있음
	- 너무 높게 잡는 경우, 동시 요청이 늘어 날 때 리소스 임계점을 넘어 서버가 다운 될 위험성이 있다.
	- [!] 최대 스레드 수의 적정 수치:
		- 적정 수치는 어플리케이션 로직의 복잡도, CPU, 메모리, IO 리소스 상황등에 따라 달라짐
			- 따라서 최대한 실제 서비스와 유사하게 성능 테스트를 진행하고 이에 따라 튜닝
				- 테스트 툴 : Apache ab, JMeter, nGrinder 
		- ["] 클라우드의 경우에는 서버를 늘리는 것을 우선으로 생각하고 그 이후에 튜닝, 클라우드가 아니라면 바로 튜닝





